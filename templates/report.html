<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bundle Size Treemap</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 20px;
        background: #fafafa;
      }

      h1 {
        margin-bottom: 12px;
      }

      #chart {
        width: 100%;
        height: 80vh;
        position: relative;
      }

      .node {
        position: absolute;
        border: 1px solid #fff;
        color: #111;
        overflow: hidden;
        padding: 6px;
        box-sizing: border-box;
        font-size: 12px;
        line-height: 1.25;
      }

      .node-title {
        font-weight: 600;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .node-meta {
        font-size: 11px;
        opacity: 0.9;
      }

      .tooltip {
        position: absolute;
        background: #000;
        color: #fff;
        padding: 6px 8px;
        font-size: 12px;
        border-radius: 4px;
        pointer-events: none;
        opacity: 0;
        max-width: 220px;
        z-index: 10;
      }

      .legend {
        display: flex;
        gap: 12px;
        margin-bottom: 10px;
        font-size: 12px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 2px;
      }

      .high {
        background: #2ecc71;
      }

      .medium {
        background: #f1c40f;
      } 

      .low {
        background: #e74c3c;
      }
    </style>
  </head>
  <body>
    <h1>Frontend Bundle Treemap</h1>

    <div class="legend" id="compression-legend">
      <div class="legend-item">
        <div class="legend-color high"></div>
        <span>High compression</span>
      </div>
      <div class="legend-item">
        <div class="legend-color medium"></div>
        <span>Medium compression</span>
      </div>
      <div class="legend-item">
        <div class="legend-color low"></div>
        <span>Low compression</span>
      </div>
    </div>

    <div id="chart"></div>
    <div class="tooltip" id="tooltip"></div>

    <script>
      const data = __DATA__;

      function format(bytes) {
        if (!bytes) return "â€”";
        const k = 1024;
        const sizes = ["B", "KB", "MB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (bytes / Math.pow(k, i)).toFixed(2) + " " + sizes[i];
      }

      // Detect if compression data exists
      const hasCompression = data.children.some(
        f => typeof f.gzip === "number" || typeof f.brotli === "number"
      );

      // Hide legend if no compression is present
      if (!hasCompression) {
        const legend = document.getElementById("compression-legend");
        if (legend) legend.style.display = "none";
      }

      // Compression efficiency: 1 - (compressed / raw)
      function compressionEfficiency(d) {
        if (!d.raw || (!d.gzip && !d.brotli)) return 0;
        const compressed = d.brotli || d.gzip;
        return 1 - compressed / d.raw;
      }

      function buildTooltipHTML(d) {
        let html = `<strong>${d.name}</strong><br/>`;
        html += `Raw: ${format(d.raw)}<br/>`;

        if (typeof d.gzip === "number") {
          html += `Gzip: ${format(d.gzip)}<br/>`;
        }

        if (typeof d.brotli === "number") {
          html += `Brotli: ${format(d.brotli)}<br/>`;
        }

        if (typeof d.gzip === "number" || typeof d.brotli === "number") {
          html += `Saved: ${(compressionEfficiency(d) * 100).toFixed(0)}%`;
        }

        return html;
      }

      const colorScale = d3
        .scaleLinear()
        .domain([0, 0.5, 0.8])
        .range(["#e74c3c", "#f1c40f", "#2ecc71"])
        .clamp(true);

      const chartEl = document.getElementById("chart");
      const width = chartEl.clientWidth;
      const height = chartEl.clientHeight;

      const root = d3
        .hierarchy(data)
        .sum((d) => d.value)
        .sort((a, b) => b.value - a.value);

      d3.treemap().size([width, height]).padding(1)(root);

      const chart = d3.select("#chart");
      const tooltip = d3.select("#tooltip");

      const nodes = chart
        .selectAll(".node")
        .data(root.leaves())
        .enter()
        .append("div")
        .attr("class", "node")
        .style("left", (d) => d.x0 + "px")
        .style("top", (d) => d.y0 + "px")
        .style("width", (d) => Math.max(0, d.x1 - d.x0) + "px")
        .style("height", (d) => Math.max(0, d.y1 - d.y0) + "px")
        .style("background", (d) => {
          if (compressionEfficiency(d.data)) {
            return colorScale(compressionEfficiency(d.data))
          } else {
            return "#bdc3c7"; // Gray for no compression data
          }
        })
        .on("mousemove", (event, d) => {
          const offset = 10;
          const pageWidth = window.innerWidth;
          const isRightHalf = event.pageX > pageWidth / 2;

          tooltip.style("opacity", 1).html(buildTooltipHTML(d.data));

          const tooltipRect = tooltip.node().getBoundingClientRect();
          const left = isRightHalf
            ? event.pageX - tooltipRect.width - offset
            : event.pageX + offset;

          tooltip
            .style("left", left + "px")
            .style("top", event.pageY + offset + "px");
        })
        .on("mouseleave", () => tooltip.style("opacity", 0));

      // In-box labels
      nodes.each(function (d) {
        const el = d3.select(this);
        const w = d.x1 - d.x0;
        const h = d.y1 - d.y0;

        el.append("div").attr("class", "node-title").text(d.data.name);

        el.append("div")
          .attr("class", "node-meta")
          .text(`Raw: ${format(d.data.raw)}`);

        if (d.data.gzip) {
          el.append("div")
            .attr("class", "node-meta")
            .text(`Gzip: ${format(d.data.gzip)}`);
        }

        if (d.data.brotli) {
          el.append("div")
            .attr("class", "node-meta")
            .text(`Brotli: ${format(d.data.brotli)}`);
        }

        const eff = compressionEfficiency(d.data);
        if(eff && (d.data.gzip || d.data.brotli)){
          el.append("div")
            .attr("class", "node-meta")
            .text(`Saved: ${(eff * 100).toFixed(0)}%`);
        }
      });
    </script>
  </body>
</html>
